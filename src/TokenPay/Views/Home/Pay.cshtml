@{
    ViewData["Title"] = "支付页";
}
@using TokenPay.Domains;
@model TokenPay.Domains.TokenOrders
@if (Model == null)
{
    <div class="row align-items-center h-100">
        <div class="text-center">
            <h1 class="display-4">订单不存在！</h1>
        </div>
    </div>

}
else
{
    <div class="text-center pt-2">
        <h4 class="display-6">您正在支付 <span class="text-danger">@Model.Currency.ToDescriptionOrString()</span></h4>

        <div class="d-flex mb-3">
            <div class="input-group m-auto" style="min-width:370px;max-width:370px;">
                <input class="form-control form-control-sm" type="text" id="Token" value="@Model.ToAddress" readonly>
                <button class="btn btn-primary btn-sm" data-clipboard-target="#Token">复制</button>
            </div>
        </div>
        <div class="mb-3">
            <img src="data:image/png;base64,@ViewData["QrCode"]" class="border border-gray-300" alt="收款地址">
        </div>
        <div class="mb-3">
            您支付金额为：<span class="text-danger">@Model.Amount</span><button class="btn btn-primary btn-sm ms-2" data-clipboard-text="@Model.Amount">复制</button>
        </div>
        <div class="mb-3">
            您的订单号：<span class="text-danger">@Model.OutOrderId</span>
        </div>
        <div class="mb-3">
            此订单过期时间为：<span class="text-danger">@ViewData["ExpireTime"]</span>
        </div>
    </div>

    @section Scripts{
    <script>
        let Time;
        $(() => {
            Time = setInterval(Check, 1000)
        })
        function Check() {
            var RedirectUrl = "@(Model?.RedirectUrl)";
            $.get("/Check/@(Model?.Id)")
                .then(x => {
                    if (x === 'Pending') {
                        console.log('待支付')
                    } else if (x === 'Expired') {
                        clearInterval(Time)
                        console.log('订单过期')
                        location.reload();
                    } else if (x === 'Paid') {
                        clearInterval(Time)
                        console.log('已支付')
                        setTimeout(() => {
                            alert("已支付")
                            if (RedirectUrl) {
                                location = RedirectUrl
                            }
                        }, 0)
                    }
                })
        }
    </script>
    }
}
